<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>道路健康度</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        body {
            width: 95%;
        }

        #main-chart,
        #line-chart {
            width: 100%;
            height: 500px;
            margin-bottom: 40px;
        }
    </style>
</head>

<body>
    <h2 style="margin-left: 30px;">道路健康度时间散点图</h2>
    <div id="main-chart" style="width: 100%; height: 400px;"></div>
    <div id="line-chart" style="width: 100%; height: 400px; margin-top: 20px;"></div>


    <script>
        let mainChart = echarts.init(document.getElementById('main-chart'));
        let lineChart = echarts.init(document.getElementById('line-chart'));
        let groupedData = [];
        let roadList = [];

        const validRoads = Array.from({ length: 15 }, (_, i) => `道路${i + 1}`);
        const hourRange = Array.from({ length: 9 }, (_, i) => i + 7);

        function processData(json) {
            const dataMap = new Map();

            for (let road in json) {
                if (!validRoads.includes(road)) continue;

                for (let dir in json[road]) {
                    for (let item of json[road][dir]) {
                        const [name, h, occupancy_mean, delay_mean, overspeed_num, nixing_num, bus_way_num, bicycle_way_num, health_point] = item;
                        const key = `${road}-${h}`;
                        if (!dataMap.has(key)) {
                            dataMap.set(key, {
                                road,
                                h,
                                count: 0,
                                health_point: 0,
                                occupancy_mean: 0,
                                delay_mean: 0,
                                overspeed_num: 0
                            });
                        }
                        let record = dataMap.get(key);
                        record.count += 1;
                        record.health_point += health_point;
                        record.occupancy_mean += occupancy_mean;
                        record.delay_mean += delay_mean;
                        record.overspeed_num += overspeed_num;
                    }
                }
            }

            groupedData = [];
            for (let [key, record] of dataMap.entries()) {
                groupedData.push({
                    road: record.road,
                    h: record.h,
                    health_point: record.health_point / record.count,
                    occupancy_mean: record.occupancy_mean / record.count,
                    delay_mean: record.delay_mean / record.count,
                    overspeed_num: record.overspeed_num / record.count
                });
            }

            roadList = [...new Set(groupedData.map(d => d.road))];
        }

        function renderScatterChart() {
            const timelineOptions = [];
            const timeline = [];

            for (let hour of hourRange) {
                timeline.push(`${hour}时`);
                const hourData = groupedData.filter(d => d.h === hour);

                timelineOptions.push({
                    series: [{
                        data: hourData.map(d => ({
                            name: d.road,
                            value: [d.road, d.health_point],
                            fullData: d
                        }))
                    }]
                });
            }

            const option = {
                baseOption: {
                    timeline: {
                        axisType: 'category',
                        data: timeline,
                        autoPlay: false,
                        loop: false,
                        playInterval: 1200
                    },
                    tooltip: {
                        formatter: params => `道路：${params.data.name}<br>健康度：${params.data.value[1].toFixed(2)}`
                    },
                    xAxis: {
                        type: 'category',
                        data: roadList,
                        interval: 0,
                        name: '道路名称'
                    },
                    yAxis: {
                        type: 'value',
                        min: 50,
                        max: 100,
                        name: '健康度'
                    },
                    series: [{
                        type: 'scatter',
                        symbolSize: 20,
                        itemStyle: { color: 'green' },
                        data: [] // 动态填入
                    }]
                },
                options: timelineOptions
            };

            const resizeObserver = new ResizeObserver(() => {
                mainChart.resize();
            });
            resizeObserver.observe(document.querySelector('body'));

            mainChart.setOption(option);

            // 绑定点击事件
            mainChart.on('click', function (params) {
                if (params.data && params.data.name) {
                    renderLineChart(params.data.name);
                }
            });
        }

        function renderLineChart(roadName) {
            const roadData = groupedData
                .filter(d => d.road === roadName)
                .sort((a, b) => a.h - b.h);

            const hours = roadData.map(d => d.h);
            const health = roadData.map(d => d.health_point);
            const occupancy = roadData.map(d => d.occupancy_mean);
            const delay = roadData.map(d => d.delay_mean);
            const overspeed = roadData.map(d => d.overspeed_num);

            const option = {
                title: { text: ` ${roadName} 各指标变化趋势` },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let result = `小时: ${params[0].axisValue}<br>`;
                        params.forEach(param => {
                            const value = (param.value * 1).toLocaleString(undefined, { maximumFractionDigits: 2 });
                            result += `${param.seriesName}: ${value}<br>`;
                        });
                        return result;
                    }

                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    name: '小时'
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '健康度',
                        min: 0,
                        max: 100,
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: '占有率',
                        min: 0,
                        max: 0.15,
                        position: 'left',
                        offset: 60 // 防止刻度重叠，可调整
                    },
                    {
                        type: 'value',
                        name: '延迟',
                        min: 0,
                        max: 5,
                        position: 'right'
                    },
                    {
                        type: 'value',
                        name: '超速次数',
                        min: 0,
                        max: 5,
                        position: 'right',
                        offset: 60
                    }
                ],
                legend: {
                    data: ['健康度', '占有率', '延迟', '超速次数']
                },
                series: [
                    {
                        name: '健康度',
                        type: 'line',
                        data: health,
                        yAxisIndex: 0,
                        smooth: true,
                        itemStyle: { color: 'green' }
                    },
                    {
                        name: '占有率',
                        type: 'line',
                        data: occupancy,
                        yAxisIndex: 1,
                        smooth: true,
                        itemStyle: { color: 'blue' }
                    },
                    {
                        name: '延迟',
                        type: 'line',
                        data: delay,
                        yAxisIndex: 2,
                        smooth: true,
                        itemStyle: { color: 'orange' }
                    },
                    {
                        name: '超速次数',
                        type: 'line',
                        data: overspeed,
                        yAxisIndex: 3,
                        smooth: true,
                        itemStyle: { color: 'red' }
                    }
                ]
            };

            const resizeObserver = new ResizeObserver(() => {
                lineChart.resize();
            });
            resizeObserver.observe(document.querySelector('body'));

            lineChart.setOption(option);
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetch('src/data/health.json')
                .then(res => res.json())
                .then(json => {
                    processData(json);
                    renderScatterChart();
                })
                .catch(err => console.error('JSON 加载失败:', err));
        });
    </script>

</body>

</html>